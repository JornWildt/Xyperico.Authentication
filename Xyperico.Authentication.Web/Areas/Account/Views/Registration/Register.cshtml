@model Xyperico.Authentication.Web.Areas.Account.Models.RegisterModel
@using Xyperico.Web.Mvc.Html
@{
  ViewBag.Title = _.Account.Registration;
}

<hgroup class="title">
    <h1>@ViewBag.Title</h1>
    <h2>@_.Account.CreateNewAccount</h2>
</hgroup>

@using (Html.BeginForm()) {
  @Html.AntiForgeryToken()
  @Html.ValidationSummary()

  <fieldset>
    <ol class="form inputs">
      <li>
        @Html.LabelFor(m => m.UserName)
        @Html.TextBoxFor(m => m.UserName)
        <span id="UserNameStatus"></span>
      </li>
      <li>
        @Html.LabelFor(m => m.EMail)
        @Html.TextBoxFor(m => m.EMail)
      </li>
      <li>
        @Html.LabelFor(m => m.Password)
        @Html.PasswordFor(m => m.Password)
      </li>
      <li>
        @Html.LabelFor(m => m.ConfirmPassword)
        @Html.PasswordFor(m => m.ConfirmPassword)
      </li>
    </ol>
    <ol class="form buttons">
      <li><input type="submit" value="@_.Account.Register" /></li>
    </ol>
  </fieldset>
}

@Html.Action("ExternalLoginList", "Login", new { Header = @_.Account.RegisterWithExternalService })

@Html.AutoFocusFor(m => m.UserName)

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")

<script type="text/javascript">
  var userNameTimer;
  $(document).ready(function () {
    $('#UserName').blur(function () {
      CheckUserName();
    });
    $('#UserName').keyup(function () {
      if (userNameTimer)
        clearTimeout(userNameTimer);
      var statusElement = $('#UserNameStatus');
      statusElement.html("");
      userNameTimer = setTimeout(CheckUserName, 1000);
    })
  });

  String.prototype.format = function () {
    var args = arguments;
    return this.replace(/\{(\d+)\}/g, function (m, n) { return args[n]; });
  };

  function CheckUserName() {
    var userName = $('#UserName').val();
    if (userName == "")
      return;
    var statusElement = $('#UserNameStatus');
    statusElement.html("<img src=\"/Areas/Account/Styles/spinner.gif\" /> Checking ...");
    $.get("/app/account/registration/checkusername", { userName: userName },
      function (data) {
        var statusElement = $('#UserNameStatus');
        var className = (data.Ok ? "ok" : "fail");
        var html = "<span class=\"{0}\">{1}</span>".format(className, data.Message);
        statusElement.html(html);
      });
  }
</script>
}
@section styles {
  @Html.Stylesheet("Account")
}
